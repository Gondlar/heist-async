{-# LANGUAGE OverloadedStrings, NoMonomorphismRestriction #-}

module Heist.Splices.Async where
  
import            Text.Templating.Heist
import qualified  Data.Text as T
import qualified  Text.XmlHtml as X
import            Data.Maybe (fromMaybe)

heistAsyncSplices = [ ("a-async", aAsync)
                    , ("form-async", formAsync)
                    , ("div-async", divAsync)
                    , ("activate-async", activateAsync)
                    ]

aAsync :: Monad m => Splice m
aAsync = do
  node <- getParamNode
  return [X.setAttribute "rel" "async" $ X.Element "a" (X.elementAttrs node) (X.elementChildren node)]

formAsync :: Monad m => Splice m
formAsync = do
  node <- getParamNode
  return [X.setAttribute "data-async" "1" $ X.Element "form" (X.elementAttrs node) (X.elementChildren node)]


divAsync :: Monad m => Splice m
divAsync = do
  node <- getParamNode
  let name = fromMaybe "undefined" $ X.getAttribute "name" node
  return [X.setAttribute "data-splice-name" name $ X.Element "div" (filter ((/= "name").fst) $ X.elementAttrs node) (X.elementChildren node)]
  
activateAsync :: Monad m => Splice m
activateAsync = do
  -- make sure that only the first call to this does anything.
  modifyTS $ bindSplice "activate-async" (return [])
  return [X.Element "script" [("type","text/javascript")] [X.TextNode js]]
    where js = T.unlines   [ "/*!"
                           , "* Valentine: JavaScript's Sister"
                           , "* copyright Dustin Diaz 2011 (@ded)"
                           , "* https://github.com/ded/valentine"
                           , "* License MIT"
                           , "*/!function(a){function j(a,b){for(var c in b)a[c]=b[c]}var b=function(a,b){return new n(a,b)},c=[],d={},e=c.slice,f=\"map\"in c,g=\"reduce\"in c,h=/(^\\s*|\\s*$)/g,i={each:f?function(a,b,d){c.forEach.call(a,b,d)}:function(a,b,c){for(var d=0,e=a.length;d<e;d++)d in a&&b.call(c,a[d],d,a)},map:f?function(a,b,d){return c.map.call(a,b,d)}:function(a,b,c){var d=[],e;for(e=0,l=a.length;e<l;e++)e in a&&(d[e]=b.call(c,a[e],e,a));return d},some:f?function(a,b,c){return a.some(b,c)}:function(a,b,c){for(var d=0,e=a.length;d<e;d++)if(d in a&&b.call(c,a[d],d,a))return!0;return!1},every:f?function(a,b,c){return a.every(b,c)}:function(a,b,c){for(var d=0,e=a.length;d<e;d++)if(d in a&&!b.call(c,a[d],d,a))return!1;return!0},filter:f?function(a,b,c){return a.filter(b,c)}:function(a,b,c){var d=[];for(var e=0,f=0,g=a.length;e<g;e++)if(e in a){if(!b.call(c,a[e],e,a))continue;d[f++]=a[e]}return d},indexOf:f?function(a,b,c){return a.indexOf(b,isFinite(c)?c:0)}:function(a,b,c){c=c||0;for(var d=0;d<a.length;d++)if(d in a&&a[d]===b)return d;return-1},lastIndexOf:f?function(a,b,c){return a.lastIndexOf(b,isFinite(c)?c:a.length)}:function(a,b,c){c=c||a.length,c=c>=a.length?a.length:c<0?a.length+c:c;for(var d=c;d>=0;--d)if(d in a&&a[d]===b)return d;return-1},reduce:g?function(a,b,d,e){return c.reduce.call(a,b,d,e)}:function(a,b,c,d){!a&&(a=[]);var e=0,f=a.length;if(arguments.length<3)do{if(e in a){c=a[e++];break}if(++e>=f)throw new TypeError(\"Empty array\")}while(1);for(;e<f;e++)e in a&&(c=b.call(d,c,a[e],e,a));return c},reduceRight:g?function(a,b,d,e){return c.reduceRight.call(a,b,d,e)}:function(a,b,c,d){!a&&(a=[]);var e=a.length,f=e-1;if(arguments.length<3)do{if(f in a){c=a[f--];break}if(--f<0)throw new TypeError(\"Empty array\")}while(1);for(;f>=0;f--)f in a&&(c=b.call(d,c,a[f],f,a));return c},find:function(a,b,c){var d;i.some(a,function(a,e,f){if(b.call(c,a,e,f)){d=a;return!0}});return d},reject:function(a,b,c){var d=[];for(var e=0,f=0,g=a.length;e<g;e++)if(e in a){if(b.call(c,a[e],e,a))continue;d[f++]=a[e]}return d},size:function(a){return m.toArray(a).length},pluck:function(a,b){return i.map(a,function(a){return a[b]})},compact:function(a){return i.filter(a,function(a){return!!a})},flatten:function(a){return i.reduce(a,function(a,b){if(k.arr(b))return a.concat(i.flatten(b));a[a.length]=b;return a},[])},uniq:function(a){var b=[],c,d;label:for(c=0;c<a.length;c++){for(d=0;d<b.length;d++)if(b[d]==a[c])continue label;b[b.length]=a[c]}return b}},k={fun:function(a){return typeof a==\"function\"},str:function(a){return typeof a==\"string\"},ele:function(a){!!a&&!!a.nodeType&&a.nodeType==1},arr:function(a){return a instanceof Array},arrLike:function(a){return a&&a.length&&isFinite(a.length)},num:function(a){return typeof a==\"number\"},bool:function(a){return a===!0||a===!1},args:function(a){return!!a&&!!d.hasOwnProperty.call(a,\"callee\")},emp:function(a){var b=0;return k.arr(a)?a.length===0:k.obj(a)?function(){for(var c in a){b++;break}return b===0}():a===\"\"},dat:function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)},reg:function(a){return!(!(a&&a.test&&a.exec)||!a.ignoreCase&&a.ignoreCase!==!1)},nan:function(a){return a!==a},nil:function(a){return a===null},und:function(a){return typeof a==\"undefined\"},obj:function(a){return a instanceof Object&&!k.fun(a)&&!k.arr(a)}},m={each:function(a,b,c){k.arrLike(a)?i.each(a,b,c):function(){for(var e in a)d.hasOwnProperty.call(a,e)&&b.call(c,e,a[e],a)}()},map:function(a,b,c){var e=[],f=0;return k.arrLike(a)?i.map(a,b,c):!function(){for(var g in a)d.hasOwnProperty.call(a,g)&&(e[f++]=b.call(c,g,a[g],a))}()&&e},toArray:function(a){if(!a)return[];if(a.toArray)return a.toArray();if(k.arr(a))return a;if(k.args(a))return e.call(a);return i.map(a,function(a){return a})},first:function(a){return a[0]},last:function(a){return a[a.length-1]},keys:Object.keys?function(a){return Object.keys(a)}:function(a){var b=[];for(var c in a)d.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b},values:function(a){return m.map(a,function(a,b){return b})},extend:function(a){m.each(e.call(arguments,1),function(b){for(var c in b)!k.und(b[c])&&(a[c]=b[c])});return a},trim:String.prototype.trim?function(a){return a.trim()}:function(a){return a.replace(h,\"\")},bind:function(a,b){return function(){b.apply(a,arguments)}}};j(b,i),j(b,m),b.is=k,b.v=b;var n=function(a,b){this.val=a,this._scope=b||null,this._chained=0};b.each(b.extend({},i,m),function(a,c){n.prototype[a]=function(){var a=b.toArray(arguments);a.unshift(this.val);var d=c.apply(this._scope,a);this.val=d;return this._chained?this:d}}),n.prototype.chain=function(){this._chained=1;return this},n.prototype.value=function(){return this.val};var o=a.v;b.noConflict=function(){a.v=o;return this},typeof module!=\"undefined\"&&module.exports?module.exports=b:a.v=b}(this)"
                            ,"/*!"
                            , " * Reqwest! A x-browser general purpose XHR connection manager"
                            , " * copyright Dustin Diaz 2011"
                            , " * https://github.com/ded/reqwest"
                            , " * license MIT"
                            , " */!function(window){function serial(a){var b=a.name;if(a.disabled||!b)return\"\";b=enc(b);switch(a.tagName.toLowerCase()){case\"input\":switch(a.type){case\"reset\":case\"button\":case\"image\":case\"file\":return\"\";case\"checkbox\":case\"radio\":return a.checked?b+\"=\"+(a.value?enc(a.value):!0)+\"&\":\"\";default:return b+\"=\"+(a.value?enc(a.value):!0)+\"&\"}break;case\"textarea\":return b+\"=\"+enc(a.value)+\"&\";case\"select\":return b+\"=\"+enc(a.options[a.selectedIndex].value)+\"&\"}return\"\"}function enc(a){return encodeURIComponent(a)}function reqwest(a,b){return new Reqwest(a,b)}function init(o,fn){function error(a){o.error&&o.error(a),complete(a)}function success(resp){o.timeout&&clearTimeout(self.timeout)&&(self.timeout=null);var r=resp.responseText;switch(type){case\"json\":resp=eval(\"(\"+r+\")\");break;case\"js\":resp=eval(r);break;case\"html\":resp=r}fn(resp),o.success&&o.success(resp),complete(resp)}function complete(a){o.complete&&o.complete(a)}this.url=typeof o==\"string\"?o:o.url,this.timeout=null;var type=o.type||setType(this.url),self=this;fn=fn||function(){},o.timeout&&(this.timeout=setTimeout(function(){self.abort(),error()},o.timeout)),this.request=getRequest(o,success,error)}function setType(a){if(/\\.json$/.test(a))return\"json\";if(/\\.jsonp$/.test(a))return\"jsonp\";if(/\\.js$/.test(a))return\"js\";if(/\\.html?$/.test(a))return\"html\";if(/\\.xml$/.test(a))return\"xml\";return\"js\"}function Reqwest(a,b){this.o=a,this.fn=b,init.apply(this,arguments)}function getRequest(a,b,c){if(a.type!=\"jsonp\"){var f=xhr();f.open(a.method||\"GET\",typeof a==\"string\"?a:a.url,!0),setHeaders(f,a),f.onreadystatechange=readyState(f,b,c),a.before&&a.before(f),f.send(a.data||null);return f}var d=doc.createElement(\"script\");window[getCallbackName(a)]=generalCallback,d.type=\"text/javascript\",d.src=a.url,d.async=!0;var e=function(){a.success&&a.success(lastValue),lastValue=undefined,head.removeChild(d)};d.onload=e,d.onreadystatechange=function(){d.readyState==\"loaded\"&&e()},head.appendChild(d)}function generalCallback(a){lastValue=a}function getCallbackName(a){var b=a.jsonpCallback||\"callback\";if(a.url.slice(-(b.length+2))==b+\"=?\"){var c=\"reqwest_\"+uniqid++;a.url=a.url.substr(0,a.url.length-1)+c;return c}var d=new RegExp(b+\"=([\\\\w]+)\");return a.url.match(d)[1]}function setHeaders(a,b){var c=b.headers||{};c.Accept=\"text/javascript, text/html, application/xml, text/xml, */*\",c[\"X-Requested-With\"]=c[\"X-Requested-With\"]||\"XMLHttpRequest\";if(b.data){c[\"Content-type\"]=\"application/x-www-form-urlencoded\";for(var d in c)c.hasOwnProperty(d)&&a.setRequestHeader(d,c[d],!1)}}function readyState(a,b,c){return function(){a&&a.readyState==4&&(twoHundo.test(a.status)?b(a):c(a))}}var twoHundo=/^20\\d$/,doc=document,byTag=\"getElementsByTagName\",head=doc[byTag](\"head\")[0],xhr=\"XMLHttpRequest\"in window?function(){return new XMLHttpRequest}:function(){return new ActiveXObject(\"Microsoft.XMLHTTP\")},uniqid=0,lastValue;Reqwest.prototype={abort:function(){this.request.abort()},retry:function(){init.call(this,this.o,this.fn)}},reqwest.serialize=function(a){var b=a[byTag](\"input\"),c=a[byTag](\"select\"),d=a[byTag](\"textarea\");return(v(b).chain().toArray().map(serial).value().join(\"\")+v(c).chain().toArray().map(serial).value().join(\"\")+v(d).chain().toArray().map(serial).value().join(\"\")).replace(/&$/,\"\")},reqwest.serializeArray=function(a){for(var b=this.serialize(a).split(\"&\"),c=0,d=b.length,e=[],f;c<d;c++)b[c]&&(f=b[c].split(\"=\"))&&e.push({name:f[0],value:f[1]});return e};var old=window.reqwest;reqwest.noConflict=function(){window.reqwest=old;return this},window.reqwest=reqwest}(this)"
                             , "/*!"
                             , " * Qwery - A Blazing Fast query selector engine"
                             , " * https://github.com/ded/qwery"
                             , " * copyright Dustin Diaz & Jacob Thornton 2011"
                             , " * MIT License"
                             , " */!function(a,b){function V(a,c){var d=typeof c==\"string\"?V(c)[0]:c||b;if(!d||!a)return[];if(h=S(a,c,V))return h;return X(a,d)}function U(a){var b=[],c,d;label:for(c=0;c<a.length;c++){for(d=0;d<b.length;d++)if(b[d]==a[c])continue label;b[b.length]=a[c]}return b}function T(a){return a&&a.nodeType&&(a.nodeType==1||a.nodeType==9)}function S(a,c,d){var e=typeof c==\"string\"?d(c)[0]:c||b;if(a===window||T(a))return!c||a!==window&&T(e)&&W(a,e)?[a]:[];if(a&&typeof a==\"object\"&&isFinite(a.length))return G(a);if(h=a.match(w))return(m=b.getElementById(h[1]))?[m]:[];if(h=a.match(y))return G(e.getElementsByTagName(h[1]));return!1}function R(a){var b=[],c=[],d,g,h=L.g(a)||L.s(a,a.split(B));h=h.slice(0);if(!h.length)return b;b=O(h);if(!h.length)return b;for(e=0,g=b.length,f=0;e<g;e++){n=b[e],j=n;for(d=h.length;d--;)z:while(j!==A&&(j=j.parentNode))if(p=N.apply(j,M(h[d])))break z;p&&(c[f++]=n)}return c}function Q(a,b,c){switch(a){case\"=\":return b==c;case\"^=\":return b.match(K.g(\"^=\"+c)||K.s(\"^=\"+c,new RegExp(\"^\"+P(c))));case\"$=\":return b.match(K.g(\"$=\"+c)||K.s(\"$=\"+c,new RegExp(P(c)+\"$\")));case\"*=\":return b.match(K.g(c)||K.s(c,new RegExp(P(c))));case\"~=\":return b.match(K.g(\"~=\"+c)||K.s(\"~=\"+c,new RegExp(\"(?:^|\\\\s+)\"+P(c)+\"(?:\\\\s+|$)\")));case\"|=\":return b.match(K.g(\"|=\"+c)||K.s(\"|=\"+c,new RegExp(\"^\"+P(c)+\"(-|$)\")))}return!1}function P(a){return J.g(a)||J.s(a,a.replace(C,\"\\\\$1\"))}function O(a){var c=[],d=a.pop(),e=M(d),f=e[1]||\"*\",g,i,j,k=a.length&&(h=a[0].match(w))?b.getElementById(h[1]):b;if(!k)return c;j=k.getElementsByTagName(f);for(g=0,i=j.length;g<i;g++)m=j[g],(r=N.apply(m,e))&&c.push(r);return c}function N(a,b,c,e,f,g,h){var j,k,l;if(b&&this.tagName.toLowerCase()!==b)return!1;if(c&&(j=c.match(u))&&j[1]!==this.id)return!1;if(c&&(q=c.match(v)))for(d=q.length;d--;){k=q[d].slice(1);if(!(I.g(k)||I.s(k,new RegExp(\"(^|\\\\s+)\"+k+\"(\\\\s+|$)\"))).test(this.className))return!1}if(e&&!h){i=this.attributes;for(l in i)if(Object.prototype.hasOwnProperty.call(i,l)&&(i[l].name||l)==f)return this}if(e&&!Q(g,this.getAttribute(f)||\"\",h))return!1;return this}function M(a){return a.match(F)}function G(a){k=[];for(d=0,o=a.length;d<o;d++)k[d]=a[d];return k}var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=/#([\\w\\-]+)/,v=/\\.[\\w\\-]+/g,w=/^#([\\w\\-]+$)/,x=/^\\.([\\w\\-]+)$/,y=/^([\\w\\-]+)$/,z=/^([\\w]+)?\\.([\\w\\-]+)$/,A=b.documentElement,B=/\\s(?![\\s\\w\\-\\/\\?\\&\\=\\:\\.\\(\\)\\!,@#%<>\\{\\}\\$\\*\\^'\\\"]*\\])/,C=/([.*+?\\^=!:${}()|\\[\\]\\/\\\\])/g,D=/^([a-z0-9]+)?(?:([\\.\\#]+[\\w\\-\\.#]+)?)/,E=/\\[([\\w\\-]+)(?:([\\|\\^\\$\\*\\~]?\\=)['\\\"]?([ \\w\\-\\/\\?\\&\\=\\:\\.\\(\\)\\!,@#%<>\\{\\}\\$\\*\\^]+)[\\\"']?)?\\]/,F=new RegExp(D.source+\"(\"+E.source+\")?\"),H=function(){this.c={}};H.prototype={g:function(a){return this.c[a]||undefined},s:function(a,b){this.c[a]=b;return b}};var I=new H,J=new H,K=new H,L=new H,W=\"compareDocumentPosition\"in A?function(a,b){return(b.compareDocumentPosition(a)&16)==16}:\"contains\"in A?function(a,c){c=c==b||c==window?A:c;return c!==a&&c.contains(a)}:function(a,b){while(a=a.parentNode)if(a===b)return 1;return 0},X=b.querySelector&&b.querySelectorAll?function(a,c){if(b.getElementsByClassName&&(h=a.match(x)))return G(c.getElementsByClassName(h[1]));return G(c.querySelectorAll(a))}:function(a,c){var d=[],f,i=[],j;if(h=a.match(z)){s=c.getElementsByTagName(h[1]||\"*\"),k=I.g(h[2])||I.s(h[2],new RegExp(\"(^|\\\\s+)\"+h[2]+\"(\\\\s+|$)\"));for(j=0,g=s.length,e=0;j<g;j++)k.test(s[j].className)&&(d[e++]=s[j]);return d}for(j=0,s=a.split(\",\"),g=s.length;j<g;j++)i[j]=R(s[j]);for(j=0,g=i.length;j<g&&(f=i[j]);j++){var l=f;if(c!==b){l=[];for(e=0,h=f.length;e<h&&(element=f[e]);e++)W(element,c)&&l.push(element)}d=d.concat(l)}return U(d)};V.uniq=U;var Y=a.qwery;V.noConflict=function(){a.qwery=Y;return this},a.qwery=V}(this,document)"
                           , "/*!"
                           , " * Heist-Async - Javascript to replace page elements based on returned contents"
                           , " */!function(){var a=document,b=a.documentElement,c=null,d=function(a,b){while(a&&a.nodeName!=b)a=a.parentNode;return a},e=function(a){var b=document.createElement(\"div\");b.innerHTML=a;var c=b.childNodes;for(i=0;i<c.length;i++)if(c[i].nodeName==\"DIV\"&&c[i].hasAttribute(\"data-splice-name\")){var d=qwery(\"div[data-splice-name=\"+c[i].getAttribute(\"data-splice-name\")+\"]\");d&&d[0]&&d[0].parentNode.replaceChild(c[i],d[0])}};b.onclick=function(a){a=a||window.event,c=a.target||a.srcElement;var f=d(c,\"A\")||b,g=f.href;switch(f.rel){case\"async\":case\"async-post\":reqwest({url:g,type:\"html\",success:e});break;default:return}return!1},b.onsubmit=function(a){a=a||window.event;var b=a.target||a.srcElement;if(!!b&&b.nodeName===\"FORM\"&&!!b.getAttribute(\"data-async\")){reqwest({url:b.getAttribute(\"action\")||\"\",data:reqwest.serialize(b),method:\"post\",type:\"html\",success:e});return!1}}}()"
                             ]